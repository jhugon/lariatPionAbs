//
// RooFit model of LArIAT Time of Flight System
//


#include "RooRealVar.h"
#include "RooDataSet.h"
#include "RooGaussian.h"
#include "RooFormulaVar.h"
#include "RooPlot.h"
#include "TCanvas.h"
#include "TAxis.h"
#include "TH1.h"
using namespace RooFit;

void tofRooFit()
{
   // S e t u p   c o m p o n e n t   p d f s 
   // ---------------------------------------

   // Construct observable
   RooRealVar mass2("mass2","Mass Squared [MeV^{2}]",-5e4,3e6);

   // Construct nuisance parameters
   RooRealVar true_mass("true_mass","True Mass [MeV]",938.27);
   RooRealVar d("d","Distance [m]",6.683);
   RooRealVar true_p("true_p","True Momentum [MeV]",300);
   RooRealVar sigma_p("sigma_p","Momentum Smearing Sigma [MeV]",30.);
   RooRealVar sigma_dt("sigma_dt","#Delta t Smearing Sigma [ns]",0.5);

   // Construct dependent parameters

   RooFormulaVar true_dt("true_dt","True #Delta t [ns]",
                        "sqrt(@2*@2/0.29979/0.29979*(1+@1*@1/@0/@0))",
                        RooArgList(true_p,true_mass,d));

   RooFormulaVar true_mass2("true_mass2","True Mass Squared [MeV^{2}]",
                        "pow(@0,2)",
                        RooArgList(true_mass));

   RooFormulaVar true_p2("true_p2","True Momentum Squared [MeV^{2}]",
                        "pow(@0,2)",
                        RooArgList(true_p));
   RooFormulaVar true_dt2("true_dt2","True #Delta t Squared [ns^{2}]",
                        "pow(@0,2)",
                        RooArgList(true_dt));
   RooFormulaVar variance_p("variance_p","Variance of Momentum [MeV^{2}]",
                        "pow(@0,2)",
                        RooArgList(sigma_p));
   RooFormulaVar variance_dt("variance_dt","Variance of #Delta t [ns^{2}]",
                        "pow(@0,2)",
                        RooArgList(sigma_dt));

   RooFormulaVar d2("d2","Distance^{2} [m^{2}]","pow(@0,2)",RooArgList(d));

   RooFormulaVar variance_mass2("variance_mass2","Mass Squared Variance [MeV^4]",
                        "4/true_dt2*pow(true_mass2+true_p2,2)*variance_dt + 4*pow(true_mass2,2)/true_p2*variance_p",
                        RooArgList(true_mass2,true_p2,true_dt2,d2,variance_p,variance_dt));

   RooFormulaVar sigma_mass2("sigma_mass2","Mass Squared Sigma [MeV^2]",
                        "sqrt(@0)",
                        RooArgList(variance_mass2));

   //true_mass2.Print();
   //true_p2.Print();
   //true_dt2.Print();
   //d2.Print();
   //variance_p.Print();
   //variance_dt.Print();
   //variance_mass2.Print();
   //sigma_mass2.Print();

   //RooFormulaVar mean_mass2("true_mass2","True Mass Squared [MeV]",
   //                     "@0*@0*(@1*@1*0.29979*0.29979/@2/@2-1.)",
   //                     RooArgList(true_p,true_dt,d));

   // Construct PDFs
   RooGaussian gauss("gauss","Gaussian",mass2,true_mass2,sigma_mass2);

   RooAbsPdf* modelPtr = dynamic_cast<RooAbsPdf*>(&gauss);

   // S a m p l e ,   f i t   a n d   p l o t   c o n v o l u t e d   p d f 
   // ----------------------------------------------------------------------

   // Sample 1000 events in x from gxlx
   RooDataSet* toy_data = gauss.generate(RooArgList(mass2),5000);

//   // Fit gxlx to data
//   //mass2_model.fitTo(*data);
//
//   // Plot data, landau pdf, landau (X) gauss pdf
   RooPlot* frame = mass2.frame(Title(""));
   toy_data->plotOn(frame);
   gauss.plotOn(frame);
//
//   // Draw frame on canvas
   TCanvas* c = new TCanvas("c");
   //gPad->SetLeftMargin(0.15); frame->GetYaxis()->SetTitleOffset(1.4);
   frame->Draw();
   c->SaveAs("FitTOF.png");
   c->SaveAs("FitTOF.pdf");

}



